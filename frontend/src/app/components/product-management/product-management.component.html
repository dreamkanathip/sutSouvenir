<div class="body">
  <div class="table-container">
    <app-navbar-admin></app-navbar-admin>
    <div class="card shadow-lg">
      <div class="card-header">
        <button
          class="submit"
          data-bs-toggle="modal"
          data-bs-target="#addProductModal"
          style="font-size: 1.2rem"
        >
          + เพิ่มสินค้า
        </button>
      </div>
      <div class="card-body">
        <table class="table table-hover">
          <thead>
            <tr>
              <th scope="col">รูปภาพ</th>
              <th scope="col">ชื่อสินค้า</th>
              <th scope="col">จำนวนสินค้า</th>
              <th scope="col">ราคา</th>
              <th scope="col">คำอธิบาย</th>
              <th scope="col">หมวดหมู่</th>
              <th scope="col">จัดการ</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let product of pagedProducts; let i = index">
              <td>
                <ng-container
                  *ngIf="product.images && getImageUrl(product.id) !== 'none'"
                >
                  <img
                    [src]="getImageUrl(product.id)"
                    alt="Product Image"
                    class="product-image"
                  />
                </ng-container>
              </td>
              <td>{{ product.title }}</td>
              <td>{{ product.quantity }}</td>
              <td>{{ product.price }}</td>
              <td>{{ product.description }}</td>
              <td>{{ product.category.name }}</td>
              <td>
                <div
                  class="d-flex flex-row align-items-center justify-content-center"
                  *ngIf="product.title"
                >
                  <button
                    class="btn btn-warning d-flex align-items-center justify-content-center"
                    (click)="editProduct(product.id)"
                  >
                    <i class="bx bx-pencil"></i>
                  </button>
                  <button
                    class="btn btn-danger d-flex align-items-center justify-content-center"
                    (click)="deleteProductById($event, product.id)"
                  >
                    <i class="bx bx-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Pagination Controls using mat-paginator -->
        <div class="pagination-controls">
          <mat-paginator
            [length]="products.length"
            [pageSize]="itemsPerPage"
            [pageSizeOptions]="[5, 10, 50, 100]"
            aria-label="Select page"
            (page)="onPageChange($event)"
          >
          </mat-paginator>
        </div>
      </div>
    </div>

    <!-- แสดงผล Card แก้ไขสินค้า -->
    <div *ngIf="editMode" class="edit-card show">
      <h3>แก้ไขข้อมูลสินค้า</h3>
      <form (ngSubmit)="saveEditProduct()">
        <div class="form-group mb-3">
          <label for="title">ชื่อสินค้า</label>
          <input
            type="text"
            id="title"
            [(ngModel)]="selectedProduct.title"
            name="title"
            class="form-control"
            required
          />
        </div>
        <div class="form-group mb-3">
          <label for="quantity">จำนวน</label>
          <input
            type="number"
            id="quantity"
            [(ngModel)]="selectedProduct.quantity"
            name="quantity"
            class="form-control"
            required
          />
        </div>
        <div class="form-group mb-3">
          <label for="price">ราคา</label>
          <input
            type="number"
            id="price"
            [(ngModel)]="selectedProduct.price"
            name="price"
            class="form-control"
            required
          />
        </div>
        <div class="form-group mb-3">
          <label for="description">คำอธิบาย</label>
          <textarea
            id="description"
            [(ngModel)]="selectedProduct.description"
            name="description"
            class="form-control"
            required
          ></textarea>
        </div>

        <div class="form-group mb-3">
          <label for="image">อัปโหลดรูปภาพใหม่</label>
          <input
            type="file"
            id="image"
            (change)="onFileSelected($event)"
            class="form-control"
            accept="image/*"
          />

          <!-- แสดงตัวอย่างรูปภาพใหม่ -->
          <div *ngIf="previewImage" class="mt-3 text-center">
            <p>รูปภาพใหม่:</p>
            <img
              [src]="previewImage"
              alt="Preview Image"
              class="img-thumbnail border border-primary rounded"
              width="150"
            />
            <button
              class="btn btn-danger btn-sm mt-2"
              type="button"
              (click)="removeImage()"
            >
              ลบรูปภาพ
            </button>
          </div>

          <!-- แสดงรูปภาพปัจจุบันถ้ายังไม่ได้เลือกรูปใหม่ -->
          <div
            *ngIf="!previewImage && selectedProduct.images"
            class="mt-3 text-center"
          >
            <p>รูปภาพปัจจุบัน:</p>
            <img
              [src]="selectedProduct.images"
              alt="Current Product Image"
              class="img-thumbnail border border-secondary rounded"
              width="150"
            />
          </div>
        </div>

        <button type="submit" class="btn btn-primary me-3">
          บันทึกการแก้ไข
        </button>
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeEditCard()"
        >
          ยกเลิก
        </button>
      </form>
    </div>
  </div>

  <app-add-product class="modal fade" id="addProductModal"></app-add-product>
</div>
